# Tree to Flat with WeakMap: éä¾µå…¥å¼æ ‘å½¢ç»“æ„ç®¡ç†æ–¹æ¡ˆ

æœ¬é¡¹ç›®æ—¨åœ¨å±•ç¤ºä¸€ç§é«˜æ•ˆã€ç°ä»£ä¸”æ— å‰¯ä½œç”¨çš„æ ‘å½¢æ•°æ®ç®¡ç†æ¨¡å¼ã€‚é€šè¿‡ JavaScript çš„ `WeakMap` ç‰¹æ€§ï¼Œæˆ‘ä»¬åœ¨å†…å­˜ä¸­æ„å»ºäº†ä¸€å¥—â€œèŠ‚ç‚¹åˆ°çˆ¶çº§â€çš„æ‰å¹³åŒ–ç´¢å¼•ç³»ç»Ÿï¼Œè§£å†³äº†æ ‘ç»“æ„ä¸­æœ€ä¸ºæ£˜æ‰‹çš„â€œç”±å­å¯»çˆ¶â€å’Œâ€œå±€éƒ¨çŠ¶æ€æ›´æ–°â€é—®é¢˜ã€‚

---

## ğŸ§  æŠ½è±¡åŸç†ï¼šä¸ºä»€ä¹ˆæ˜¯ WeakMapï¼Ÿ

åœ¨ä¼ ç»Ÿçš„æ ‘ç»“æ„å¤„ç†ä¸­ï¼Œå¦‚æœéœ€è¦è·å–æŸä¸ªèŠ‚ç‚¹çš„çˆ¶çº§æˆ–ç¥–å…ˆè·¯å¾„ï¼Œé€šå¸¸æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š
1. **é€’å½’æœç´¢**ï¼šæ¯æ¬¡æŸ¥æ‰¾éƒ½éå†æ•´æ£µæ ‘ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(N)$ã€‚
2. **æ‰‹åŠ¨æŒ‚è½½ `parent` å±æ€§**ï¼šåœ¨åŸå§‹æ•°æ®ä¸Šå¼ºè¡Œæ³¨å…¥çˆ¶èŠ‚ç‚¹å¼•ç”¨ã€‚

**è¿™ä¸¤ç§æ–¹æ¡ˆéƒ½æœ‰æ˜æ˜¾çš„ç¼ºé™·ï¼š** é€’å½’æ•ˆç‡ä½ä¸‹ï¼Œè€Œæ‰‹åŠ¨æŒ‚è½½å±æ€§ä¼šå¯¼è‡´å¯¹è±¡å¾ªç¯å¼•ç”¨ï¼ˆæ— æ³•è¢« `JSON.stringify` åºåˆ—åŒ–ï¼‰ï¼Œä¸”æ±¡æŸ“äº†åŸå§‹ä¸šåŠ¡æ•°æ®ã€‚

### æ ¸å¿ƒæ–¹æ¡ˆï¼šå»ºç«‹â€œå½±å­ç´¢å¼•â€
æˆ‘ä»¬åˆ©ç”¨ `WeakMap` çš„ç‰¹æ€§ï¼Œåœ¨åŸå§‹æ ‘æ•°æ®ä¹‹å¤–ç»´æŠ¤ä¸€å¼ â€œå½±å­ç´¢å¼•è¡¨â€ï¼š
- **$O(1)$ æŸ¥æ‰¾**ï¼šé€šè¿‡èŠ‚ç‚¹å¼•ç”¨ç›´æ¥è·å–å…¶çˆ¶èŠ‚ç‚¹ã€‚
- **éä¾µå…¥æ€§**ï¼šåŸå§‹æ•°æ®å¯¹è±¡ä¿æŒçº¯å‡€ï¼Œæ²¡æœ‰ä»»ä½•å¤šä½™å±æ€§ã€‚
- **å†…å­˜å®‰å…¨**ï¼š`WeakMap` å¯¹é”®æ˜¯å¼±å¼•ç”¨ã€‚å¦‚æœåŸå§‹æ ‘ä¸­çš„èŠ‚ç‚¹è¢«åˆ é™¤ä¸”æ²¡æœ‰å…¶ä»–å¼•ç”¨ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šè‡ªåŠ¨æ¸…ç†ç´¢å¼•è¡¨ä¸­çš„å¯¹åº”é¡¹ã€‚

---

## ğŸ› ï¸ é¡¹ç›®æ·±åº¦æ‹†è§£ä¸ä½¿ç”¨ç»†èŠ‚

### 1. åŸç”Ÿ HTML/JS å®ç°ï¼šDOM ä¸æ•°æ®çš„ç²¾å‡†ç»‘å®š
åœ¨åŸç”Ÿå¼€å‘ä¸­ï¼Œæœ¬é¡¹ç›®é€šè¿‡åŒé‡ç´¢å¼•è§£å†³äº† DOM å…ƒç´ ã€ä¸šåŠ¡æ•°æ®ä¸çˆ¶çº§å…³ç³»ä¹‹é—´çš„å…³è”ã€‚

- **å®ç°ç»†èŠ‚**ï¼š
    - `_treeWeakMap`ï¼šå­˜å‚¨ `Node -> Parent | List`ã€‚å¦‚æœæ˜¯æ ¹èŠ‚ç‚¹ï¼Œå…¶çˆ¶çº§æŒ‡å‘æ•´ä¸ªæ ‘æ•°æ®æ•°ç»„ã€‚
    - `_domDataMap`ï¼šå­˜å‚¨ `HTMLElement -> NodeData`ï¼Œå®ç°ä»è§†å›¾å±‚åˆ°æ•°æ®å±‚çš„ç§’çº§è·³è½¬ã€‚
- **å…·ä½“ç¤ºä¾‹**ï¼š
    ```javascript
    // html/tree.js
    function handleAction(action, node) {
        if (action === 'delete') {
            const parent = getParent(node); // ä» WeakMap è·å–
            if (_isRootNode(parent)) {
                // å¦‚æœçˆ¶çº§æ˜¯æ•°ç»„ï¼Œè¯´æ˜æ˜¯æ ¹èŠ‚ç‚¹
                const index = parent.findIndex(item => item === node);
                parent.splice(index, 1);
            } else {
                // å¦‚æœæ˜¯æ™®é€šèŠ‚ç‚¹ï¼Œä»çˆ¶èŠ‚ç‚¹çš„ children ä¸­è¿‡æ»¤
                parent[treeNodeProp.children] = parent[treeNodeProp.children].filter(item => item !== node);
            }
            render(); // é‡æ–°æ„å»ºç´¢å¼•å¹¶æ¸²æŸ“
        }
    }
    ```
- **æºç å‚è€ƒ**ï¼š[tree.js](file:///html/tree.js)

### 2. React + Ant Designï¼šHook é©±åŠ¨çš„æŒä¹…åŒ–ç´¢å¼•
React ç‰ˆæœ¬å±•ç¤ºäº†å¦‚ä½•å°†ç´¢å¼•é€»è¾‘å°è£…ä¸ºå¯å¤ç”¨çš„ Hookï¼Œå¹¶å¤„ç†ç»„ä»¶é‡æ¸²æŸ“å¸¦æ¥çš„å¼•ç”¨é—®é¢˜ã€‚

- **å®ç°ç»†èŠ‚**ï¼š
    - ä½¿ç”¨ `useRef(new WeakMap())` ç¡®ä¿ `WeakMap` å®ä¾‹åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå†…å”¯ä¸€ã€‚
    - `initTree` æ–¹æ³•æ”¯æŒè‡ªå®šä¹‰å­—æ®µåï¼ˆlabel/value/childrenï¼‰ã€‚
- **å…·ä½“ç¤ºä¾‹**ï¼š
    ```tsx
    // react_demo/src/hooks/useTree.ts
    const { getParentLabels, initTree } = useTree({
        treeNodeProp: { label: 'name', value: 'id', children: 'children' }
    });

    // è·¯å¾„å›æº¯é€»è¾‘ï¼šä½¿ç”¨ while å¾ªç¯å‘ä¸Šè¿½æº¯
    const getParents = useCallback((item, parentList = [], key) => {
        let current = item;
        const result = [...parentList];
        while (true) {
            const parent = treeWeakMap.current.get(current);
            if (parent && !isRootNode(parent)) {
                result.push(key ? parent[key] : parent);
                current = parent;
            } else {
                break;
            }
        }
        return result;
    }, []);
    ```
- **æºç å‚è€ƒ**ï¼š[useTree.ts (React)](file:///react_demo/src/hooks/useTree.ts)

### 3. Vue 3ï¼šComposition API ä¸å“åº”å¼è€ƒé‡
Vue ç‰ˆæœ¬å¼ºè°ƒäº†åœ¨ Proxy å“åº”å¼ç³»ç»Ÿä¸‹ï¼Œå¦‚ä½•ä¿æŒèŠ‚ç‚¹å¼•ç”¨çš„ä¸€è‡´æ€§ã€‚

- **å®ç°ç»†èŠ‚**ï¼š
    - `getParents` é‡‡ç”¨ **é€’å½’æ–¹å¼** å®ç°ï¼Œå±•ç¤ºäº†å¦ä¸€ç§é€»è¾‘é£æ ¼ã€‚
    - åœ¨ `addChild` æ—¶ï¼Œç‰¹åˆ«æ³¨æ„äº† Proxy å¤„ç†åçš„èŠ‚ç‚¹å¼•ç”¨æ³¨å†Œã€‚
- **å…·ä½“ç¤ºä¾‹**ï¼š
    ```typescript
    // vue_demo/src/hooks/useTree.ts
    function getParents(item: TreeNode, parentList: (TreeNode | string)[] = [], key?: string) {
        const parent = _treeWeakMap.get(item);
        // é€’å½’å‘ä¸Šè¿½æº¯ç›´åˆ°æ ¹èŠ‚ç‚¹æ•°ç»„
        if (parent && !_isRootNode(parent)) {
            parentList.push(key ? parent[key] : parent);
            getParents(parent, parentList, key);
        }
        return parentList;
    }
    ```
- **æºç å‚è€ƒ**ï¼š[useTree.ts (Vue)](file:///vue_demo/src/hooks/useTree.ts)

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | ä¼ ç»Ÿé€’å½’æ–¹æ¡ˆ | æ‰‹åŠ¨æŒ‚è½½ parent | **WeakMap æ–¹æ¡ˆ (æœ¬é¡¹ç›®)** |
| :--- | :--- | :--- | :--- |
| **æŸ¥æ‰¾æ•ˆç‡** | $O(N)$ | $O(1)$ | **$O(1)$** |
| **æ•°æ®åºåˆ—åŒ–** | å®Œç¾æ”¯æŒ | ä¸æ”¯æŒ (å¾ªç¯å¼•ç”¨) | **å®Œç¾æ”¯æŒ (æ•°æ®çº¯å‡€)** |
| **å¼€å‘ä¾µå…¥æ€§** | æ—  | é«˜ (ä¿®æ”¹åŸå§‹å¯¹è±¡) | **æ—  (å®Œå…¨éš”ç¦»)** |
| **å†…å­˜ç®¡ç†** | è‡ªåŠ¨ | éœ€æ‰‹åŠ¨ç½®ç©ºé˜²æ³„æ¼ | **è‡ªåŠ¨ (å¼±å¼•ç”¨ç‰¹æ€§)** |

## ğŸš€ è¿è¡ŒæŒ‡å—

1. **HTML ç‰ˆ**ï¼šç›´æ¥æµè§ˆå™¨æ‰“å¼€ `html/index.html`ã€‚
2. **React ç‰ˆ**ï¼šè¿›å…¥ `react_demo` ç›®å½•ï¼Œæ‰§è¡Œ `pnpm i` åŠå…¶ `pnpm dev`ã€‚
3. **Vue ç‰ˆ**ï¼šè¿›å…¥ `vue_demo` ç›®å½•ï¼Œæ‰§è¡Œ `pnpm i` åŠå…¶ `pnpm dev`ã€‚

---
Â© 2026 Tree to Flat Project - æ¢ç´¢æ›´ä¼˜é›…çš„æ•°æ®ç»“æ„ç®¡ç†ã€‚
